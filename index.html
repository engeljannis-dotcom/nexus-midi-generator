<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#05050a">
    <title>NEXUS GENERATOR v6</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05050a; --pnl: #0a0a10; --brd: #1e1e2e; --ph: #d4ff00;
            --txt: #c8c8d8; --mut: #404058; --red: #ff2d1a; --cyn: #00d8cc;
            --amb: #ff9500; --pur: #9955ff; --blu: #3a7fff; --grn: #00ff88;
            --step-h: 22px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--txt); font-family: 'DM Mono', monospace; overflow: hidden; }

        #app { position: fixed; inset: 0; display: grid; grid-template-rows: 44px 1fr auto; background: var(--bg); }

        .grain { position: fixed; inset: 0; z-index: 9999; pointer-events: none; opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }
        .scanlines { position: fixed; inset: 0; z-index: 9998; pointer-events: none;
            background: repeating-linear-gradient(rgba(0,0,0,0) 0px, rgba(0,0,0,0.1) 1px, rgba(0,0,0,0) 2px); }

        /* HEADER */
        #hdr { display: flex; align-items: center; justify-content: space-between; padding: 0 12px; border-bottom: 1px solid var(--brd); background: var(--pnl); }
        .logo { font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--ph); letter-spacing: 1px; }
        .hdr-sep { width: 1px; height: 16px; background: var(--mut); margin: 0 10px; }
        .song-info { flex: 1; display: flex; flex-direction: column; line-height: 1; }
        .song-title { font-weight: 500; font-size: 11px; text-transform: uppercase; }
        .song-sub { font-size: 9px; color: var(--mut); }
        .chips { display: flex; gap: 6px; flex-wrap: wrap; }
        .chip { font-size: 9px; padding: 2px 6px; border: 1px solid var(--brd); border-radius: 2px; text-transform: uppercase; background: #000; }
        #chip-live { color: var(--ph); border-color: var(--ph); }
        #chip-section { color: var(--cyn); border-color: var(--cyn); }
        #chip-bar { color: var(--amb); border-color: var(--amb); }

        /* MAIN */
        #main { display: grid; overflow: hidden; }
        #left-col { display: flex; flex-direction: column; overflow: hidden; border-right: 1px solid var(--brd); }
        #video-wrap { position: relative; flex: 1; background: #000; overflow: hidden; }
        #vid-canvas { width: 100%; height: 100%; display: block; }
        .vid-overlay { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 10px; font-size: 10px; text-shadow: 0 1px 2px #000; }

        /* SONG STRUCTURE TIMELINE */
        #struct-timeline { height: 32px; background: #000; border-top: 1px solid var(--brd); display: flex; align-items: center; padding: 0 8px; gap: 3px; overflow-x: auto; }
        .tl-block {
            height: 20px; min-width: 32px; border-radius: 2px; display: flex; align-items: center; justify-content: center;
            font-size: 8px; font-family: 'Bebas Neue'; letter-spacing: 0.5px; border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; flex-shrink: 0; transition: opacity 0.2s;
        }
        .tl-block.active { border-color: var(--ph); box-shadow: 0 0 6px var(--ph); }
        .tl-block.played { opacity: 0.4; }

        #seq-panel { height: 155px; background: var(--pnl); border-top: 1px solid var(--brd); overflow-y: auto; }
        .seq-row { display: grid; grid-template-columns: 40px 1fr 30px; height: var(--step-h); border-bottom: 1px solid #151520; }
        .seq-label { font-size: 9px; display: flex; align-items: center; justify-content: center; color: var(--mut); border-right: 1px solid var(--brd); cursor: pointer; }
        .seq-label:hover { color: var(--txt); }
        .seq-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 1px; padding: 2px; overflow: hidden; }
        .s-step { background: rgba(255,255,255,0.03); border-radius: 1px; cursor: pointer; }
        .s-step.on { background: var(--clr); box-shadow: 0 0 8px var(--clr); }
        .s-step.cur { outline: 1px solid var(--ph); z-index: 2; }
        .s-step.acc { filter: brightness(1.6); }
        .vu-wrap { background: #000; position: relative; }
        .vu-bar { position: absolute; bottom: 0; width: 100%; background: var(--clr); transition: height 0.06s; opacity: 0.6; }

        /* RIGHT COL */
        #right-col { display: flex; flex-direction: column; width: 280px; background: var(--pnl); }
        #spectrum-wrap { height: 100px; border-bottom: 1px solid var(--brd); position: relative; background: #000; }
        #spec-canvas, #wave-canvas { position: absolute; inset: 0; width: 100%; height: 100%; }
        
        #structure-panel { flex: 1; padding: 8px; font-size: 10px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }
        .struct-hdr { font-family: 'Bebas Neue'; font-size: 13px; color: var(--mut); border-bottom: 1px solid var(--brd); padding-bottom: 3px; }
        .struct-item { display: flex; justify-content: space-between; padding: 2px 0; }
        .struct-val { color: var(--ph); }
        .pattern-btn-row { display: flex; gap: 3px; flex-wrap: wrap; margin-top: 2px; }
        .p-btn { height: 20px; padding: 0 6px; font-size: 9px; border-radius: 2px; }
        .p-btn.active { background: var(--ph); color: #000; border-color: var(--ph); }
        
        #midi-monitor { background: #000; border: 1px solid var(--brd); border-radius: 2px; padding: 5px; font-size: 8px; color: var(--mut); height: 60px; overflow-y: auto; }
        .midi-log-line { color: var(--cyn); }

        /* FOOTER */
        #footer { background: var(--pnl); border-top: 1px solid var(--brd); display: flex; flex-direction: column; }
        .footer-row1 { display: flex; height: 50px; align-items: center; padding: 0 10px; gap: 10px; }
        .footer-row2 { display: flex; height: 44px; align-items: center; padding: 0 10px; gap: 15px; border-top: 1px solid var(--brd); }
        
        button { background: var(--brd); color: var(--txt); border: 1px solid #444; font-family: inherit; font-size: 11px; cursor: pointer; touch-action: manipulation; display: flex; align-items: center; justify-content: center; border-radius: 2px; }
        button:active { background: #333; }
        #gen-btn { height: 34px; padding: 0 20px; background: var(--ph); color: #000; font-family: 'Bebas Neue'; font-size: 16px; border: none; }
        #gen-btn.busy { opacity: 0.5; pointer-events: none; }
        .transport-mini { display: flex; gap: 4px; }
        .t-btn { width: 34px; height: 34px; font-size: 14px; }
        #t-play.playing { background: var(--red); color: #fff; }
        #progress-wrap { flex: 1; height: 4px; background: #000; border-radius: 2px; overflow: hidden; cursor: pointer; }
        #progress-fill { width: 0%; height: 100%; background: var(--ph); transition: width 0.05s; }
        #progress-section { height: 100%; background: var(--cyn); opacity: 0.3; }

        #bpm-control { display: flex; align-items: center; gap: 8px; }
        #bpm-display { font-weight: bold; color: var(--ph); width: 30px; }
        #bpm-slider { -webkit-appearance: none; flex: 1; height: 2px; background: var(--mut); }
        #bpm-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--ph); border-radius: 50%; }

        #midi-row { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end; }
        #midi-btn { height: 28px; padding: 0 8px; gap: 6px; }
        .midi-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--mut); }
        #midi-btn.connected .midi-dot { background: var(--cyn); box-shadow: 0 0 5px var(--cyn); }
        #midi-btn.error .midi-dot { background: var(--red); }
        #midi-device-name { font-size: 9px; color: var(--mut); max-width: 100px; overflow: hidden; white-space: nowrap; }
        #midi-ch-select { height: 28px; padding: 0 6px; font-size: 9px; background: var(--brd); color: var(--txt); border: 1px solid #444; border-radius: 2px; cursor: pointer; }

        /* LOADING */
        #loading { position: fixed; inset: 0; z-index: 10000; background: var(--bg); display: none; flex-direction: column; align-items: center; justify-content: center; }
        #loading.show { display: flex; }
        .ld-title { font-family: 'Bebas Neue'; font-size: 32px; color: var(--ph); margin-bottom: 20px; }
        .ld-steps { font-size: 10px; color: var(--mut); margin-bottom: 10px; text-align: center; height: 14px; }
        .ld-bar-wrap { width: 200px; height: 2px; background: var(--brd); }
        .ld-bar { width: 0%; height: 100%; background: var(--ph); transition: width 0.3s; }

        @media (max-width: 700px) {
            #right-col { display: none; }
            #main { grid-template-columns: 1fr; }
            #seq-panel { height: 130px; }
        }
        @media (min-width: 701px) {
            #main { grid-template-columns: 1fr 280px; }
        }
    </style>
</head>
<body>
<div class="grain"></div>
<div class="scanlines"></div>

<div id="app">
    <header id="hdr">
        <div style="display:flex;align-items:center;">
            <div class="logo">NEXUS GEN v6</div>
            <div class="hdr-sep"></div>
            <div class="song-info">
                <div class="song-title" id="ui-title">IDLE_SYSTEM</div>
                <div class="song-sub" id="ui-sub">Awaiting initialization...</div>
            </div>
        </div>
        <div class="chips">
            <div class="chip" id="chip-key">C MIN</div>
            <div class="chip" id="chip-style">HYBRID</div>
            <div class="chip" id="chip-section">—</div>
            <div class="chip" id="chip-bar">BAR 0/0</div>
            <div class="chip" id="chip-live">IDLE</div>
        </div>
    </header>

    <div id="main">
        <div id="left-col">
            <div id="video-wrap">
                <canvas id="vid-canvas"></canvas>
                <div class="vid-overlay">
                    <div style="display:flex;justify-content:space-between;">
                        <span id="vid-chord">----</span>
                        <span id="vid-time">00:00:00</span>
                    </div>
                    <div style="text-align:right;color:var(--ph);font-family:'Bebas Neue';font-size:18px;" id="vid-bpm">120 BPM</div>
                </div>
            </div>
            <div id="struct-timeline"></div>
            <div id="seq-panel"></div>
        </div>
        <div id="right-col">
            <div id="spectrum-wrap">
                <canvas id="spec-canvas"></canvas>
                <canvas id="wave-canvas"></canvas>
            </div>
            <div id="structure-panel">
                <div class="struct-hdr">SONG STRUCTURE</div>
                <div class="struct-item"><span>SECTION</span><span class="struct-val" id="ui-section">-</span></div>
                <div class="struct-item"><span>BAR IN SECTION</span><span class="struct-val" id="ui-bar-in">0/0</span></div>
                <div class="struct-item"><span>TOTAL BARS</span><span class="struct-val" id="ui-total-bars">0/0</span></div>
                <div class="struct-item"><span>PATTERN VAR</span><span class="struct-val" id="ui-pat-var">A</span></div>
                <div class="struct-item"><span>MOOD</span><span class="struct-val" id="ui-mood">-</span></div>
                <div class="struct-item"><span>ENERGY</span><span class="struct-val" id="ui-energy">-</span></div>
                <div class="struct-hdr" style="margin-top:4px;">ACTIVE INSTRUMENTS</div>
                <div id="ui-active-instr" style="font-size:9px;color:var(--mut);line-height:1.8;">—</div>
                <div class="struct-hdr" style="margin-top:4px;">MIDI MONITOR</div>
                <div id="midi-monitor">// MIDI log ready...</div>
                <div style="flex:1"></div>
                <div style="font-size:8px;color:var(--mut);">MASTER COMP: ACTIVE // TR-8 COMPAT</div>
            </div>
        </div>
    </div>

    <footer id="footer">
        <div class="footer-row1">
            <button id="gen-btn"><span id="gen-txt">GENERATE</span></button>
            <div class="transport-mini">
                <button class="t-btn" id="t-stop">■</button>
                <button class="t-btn" id="t-play">▶</button>
            </div>
            <div id="progress-wrap"><div id="progress-fill"></div></div>
        </div>
        <div class="footer-row2">
            <div id="bpm-control">
                <label style="font-size:9px;color:var(--mut);">BPM</label>
                <div id="bpm-display">130</div>
                <input type="range" id="bpm-slider" min="60" max="180" value="130" step="1">
            </div>
            <div id="midi-row">
                <button id="midi-btn"><div class="midi-dot"></div>MIDI</button>
                <select id="midi-ch-select" title="MIDI Channel">
                    <option value="9">CH 10 (GM Drums)</option>
                    <option value="0">CH 1</option>
                    <option value="1">CH 2</option>
                    <option value="2">CH 3</option>
                    <option value="3">CH 4</option>
                    <option value="9" selected>CH 10 (TR-8)</option>
                </select>
                <div id="midi-device-name">NO DEVICE</div>
            </div>
        </div>
    </footer>
</div>

<div id="loading">
    <div class="ld-title">GENERATING SONG</div>
    <div id="ld-steps" class="ld-steps">Initializing...</div>
    <div class="ld-bar-wrap"><div id="ld-bar" class="ld-bar"></div></div>
</div>

<script>
/**
 * NEXUS GENERATOR v6
 * Full song structure + algorithmic Techno/HipHop patterns + TR-8 MIDI
 */
const G = (() => {
    'use strict';

    // ─── AUDIO CONTEXT ────────────────────────────────────────────────────────
    let ctx = null, mGain = null, mComp = null, limiter = null;
    let bassEQ = null, hiCut = null, analyser = null;
    let reverbConv = null, revSend = null;
    const SR = 44100;

    // ─── STATE ────────────────────────────────────────────────────────────────
    let song = null, playing = false;
    let songTime = 0, lastTs = 0;
    let globalStep = 0;          // step within 32-step bar (0-31)
    let globalBar = 0;           // absolute bar index in song
    let nextSchedTime = 0;
    let seqTimer = null;
    let bpmOverride = null;
    let isGenerating = false;
    let drumBuffers = {};
    let vizRAF = null;

    // ─── MIDI ─────────────────────────────────────────────────────────────────
    let midiAccess = null, midiOut = null;
    let midiConnected = false;
    let midiChannel = 9; // TR-8 default = ch 10 (0-indexed = 9)

    // ─── TR-8 NOTE MAP ────────────────────────────────────────────────────────
    // Roland TR-8 / TR-8S default MIDI note assignments (GM + Roland extensions)
    const TR8_NOTES = {
        bd:   36,  // Bass Drum (C2)
        sd:   38,  // Snare (D2)
        lt:   41,  // Low Tom (F1)
        mt:   45,  // Mid Tom (A1)
        ht:   48,  // High Tom (C2)
        rs:   37,  // Rimshot (C#2)
        cp:   39,  // Clap (D#2)
        hh:   42,  // Closed HH (F#2)
        oh:   46,  // Open HH (A#2)
        rc:   51,  // Ride Cymbal (D#3)
        cb:   56,  // Cowbell (G#3)
        cr:   49,  // Crash (C#3)
    };

    // ─── STYLES ───────────────────────────────────────────────────────────────
    const STYLES = [
        { name:'DARK TECHNO',   bpm:[128,142], swing:0,  dVol:0.95, bVol:0.88, mVol:0.14, vibe:'#3a7fff', energy:'HIGH' },
        { name:'ACID TECHNO',   bpm:[130,148], swing:5,  dVol:0.93, bVol:0.90, mVol:0.12, vibe:'#00d8cc', energy:'HIGH' },
        { name:'MINIMAL TECH',  bpm:[120,132], swing:3,  dVol:0.90, bVol:0.85, mVol:0.10, vibe:'#00ff88', energy:'MID' },
        { name:'INDUSTRIAL',    bpm:[136,152], swing:8,  dVol:0.96, bVol:0.86, mVol:0.11, vibe:'#404058', energy:'PEAK' },
        { name:'LOFI HIP HOP',  bpm:[72,92],   swing:58, dVol:0.90, bVol:0.80, mVol:0.22, vibe:'#ff9500', energy:'LOW' },
        { name:'BOOM BAP',      bpm:[85,100],  swing:62, dVol:0.92, bVol:0.84, mVol:0.20, vibe:'#ff2d1a', energy:'MID' },
        { name:'JAZZY LOFI',    bpm:[68,86],   swing:65, dVol:0.85, bVol:0.76, mVol:0.24, vibe:'#9955ff', energy:'LOW' },
    ];

    // ─── SCALES ───────────────────────────────────────────────────────────────
    const SCALES = {
        'Minor Pent': [0,3,5,7,10],
        'Nat Minor':  [0,2,3,5,7,8,10],
        'Dorian':     [0,2,3,5,7,9,10],
        'Phrygian':   [0,1,3,5,7,8,10],
        'Blues':      [0,3,5,6,7,10],
    };

    // ─── PATTERN LIBRARY ─────────────────────────────────────────────────────
    // 32-step patterns (index 0-31), 1=on, 2=accent, 0=off
    // Multiple variations per instrument per style
    const PAT_LIB = {
        techno: {
            bd: [
                [2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0], // 4 on floor
                [2,0,0,0, 0,0,1,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,1,0, 2,0,0,0, 0,1,0,0], // with syncopation
                [2,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,1,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,1], // broken
                [2,0,0,0, 1,0,0,0, 2,0,0,0, 1,0,0,0, 2,0,0,0, 1,0,0,0, 2,0,0,0, 1,0,0,0], // double time feel
                [2,0,0,1, 0,0,0,0, 2,0,0,0, 0,0,1,0, 2,0,1,0, 0,0,0,0, 2,0,0,0, 0,1,0,0], // complex
            ],
            sd: [
                [0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0], // standard 2/4
                [0,0,0,0, 2,0,0,1, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,1,0, 0,0,0,0, 2,0,0,1], // ghost notes
                [0,0,0,0, 2,0,0,0, 0,0,1,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,1,0,0, 2,0,1,0], // fills
                [0,0,0,0, 0,0,2,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 0,0,2,0, 0,0,0,0, 2,0,0,1], // offbeat
            ],
            cp: [
                [0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0], // on snare
                [0,0,0,0, 0,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 2,0,0,0], // minimal
                [0,0,1,0, 0,0,0,0, 2,0,0,0, 0,0,1,0, 0,0,0,0, 2,0,0,0, 0,0,1,0, 0,0,0,0], // syncopated
            ],
            hh: [
                [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0], // 8th notes
                [1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1], // 16ths
                [2,0,1,0, 2,0,1,0, 2,0,1,0, 2,0,1,2, 0,1,0,2, 0,1,0,2, 0,1,0,2, 0,1,0,1], // accented 16ths
                [1,0,1,1, 0,1,0,1, 1,0,1,0, 1,1,0,1, 1,0,1,1, 0,1,0,1, 1,0,0,1, 1,1,0,1], // shuffled
                [0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,1], // offbeat
            ],
            oh: [
                [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0], // quarter
                [0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,1, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0], // syncopated
                [0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0, 0,1,0,0], // varied
            ],
            rs: [
                [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0], // silent
                [0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,1,0, 0,0,0,0], // offbeat
                [1,0,0,0, 0,0,1,0, 0,0,0,0, 1,0,0,0, 0,1,0,0, 0,0,0,0, 1,0,0,0, 0,0,1,0], // complex
            ],
            lt: [
                [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
                [0,0,0,0, 0,1,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,1,0,0, 0,0,0,0, 0,1,0,1],
                [0,0,0,1, 0,0,0,0, 0,0,0,1, 0,0,0,0, 0,0,0,1, 0,0,0,0, 1,0,0,1, 0,0,0,0],
            ],
            cb: [
                [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
                [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0], // quarter cowbell
                [0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0],
            ],
        },
        hiphop: {
            bd: [
                [2,0,0,0, 0,0,1,0, 0,0,2,0, 0,0,0,0, 2,0,0,0, 0,0,1,0, 0,0,2,0, 0,0,0,0],
                [2,0,0,0, 0,0,0,0, 0,0,1,0, 0,0,0,0, 2,0,0,1, 0,0,0,0, 0,0,2,0, 0,1,0,0],
                [2,0,0,0, 0,1,0,0, 2,0,0,0, 0,0,0,1, 2,0,0,0, 0,1,0,0, 2,0,0,0, 0,0,0,1],
            ],
            sd: [
                [0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,1],
                [0,0,0,0, 2,0,0,0, 0,0,0,1, 2,0,0,0, 0,0,1,0, 2,0,0,0, 0,0,0,0, 2,0,1,0],
            ],
            cp: [
                [0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0, 0,0,0,0, 2,0,0,0],
            ],
            hh: [
                [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
                [1,0,1,1, 0,0,1,0, 1,0,1,0, 0,1,0,1, 1,0,1,0, 1,0,0,1, 1,0,1,0, 1,1,0,1],
                [0,1,0,1, 0,1,0,1, 0,1,0,1, 0,1,0,1, 0,1,0,1, 0,1,0,1, 0,1,0,1, 0,1,1,1],
            ],
            oh: [
                [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
                [0,0,1,0, 0,0,0,1, 0,1,0,0, 0,0,1,0, 0,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,0],
            ],
            rs: [
                [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
                [0,0,0,1, 0,0,0,0, 0,0,0,1, 0,0,0,0, 0,0,0,1, 0,0,0,0, 0,1,0,0, 0,0,0,0],
            ],
            lt: [
                [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
                [0,0,0,0, 0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,1,0,0, 0,0,0,0],
            ],
            cb: [
                [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
            ],
        },
    };

    // ─── SONG STRUCTURE TEMPLATES ─────────────────────────────────────────────
    const SONG_STRUCTURES = {
        techno: [
            { name:'INTRO',     bars:4,  energy:0.3, activeTracks:['bd','hh'],                 color:'#1a3a5e' },
            { name:'BUILDUP',   bars:4,  energy:0.5, activeTracks:['bd','hh','rs'],             color:'#1a3a4a' },
            { name:'DROP A',    bars:8,  energy:1.0, activeTracks:['bd','sd','hh','oh','rs'],   color:'#3a7fff' },
            { name:'BREAK',     bars:4,  energy:0.4, activeTracks:['hh','rs','lt'],             color:'#1a2a3e' },
            { name:'BUILD 2',   bars:4,  energy:0.7, activeTracks:['bd','hh','cp','rs'],        color:'#2a3a5e' },
            { name:'DROP B',    bars:8,  energy:1.0, activeTracks:['bd','sd','hh','oh','cp','lt'], color:'#5a8fff' },
            { name:'BREAKDOWN', bars:4,  energy:0.2, activeTracks:['hh','rs'],                 color:'#0a1a2e' },
            { name:'OUTRO',     bars:4,  energy:0.3, activeTracks:['bd','hh'],                 color:'#0a1a2e' },
        ],
        acid: [
            { name:'INTRO',     bars:4,  energy:0.3, activeTracks:['bd','hh'],                 color:'#0a3a2e' },
            { name:'RISE',      bars:8,  energy:0.6, activeTracks:['bd','hh','oh','rs'],        color:'#0a4a3a' },
            { name:'PEAK A',    bars:8,  energy:1.0, activeTracks:['bd','sd','hh','oh','cp','cb'], color:'#00d8cc' },
            { name:'RELIEF',    bars:4,  energy:0.3, activeTracks:['hh','oh'],                 color:'#0a2a2a' },
            { name:'REBUILD',   bars:4,  energy:0.7, activeTracks:['bd','hh','rs','cb'],        color:'#0a3a2e' },
            { name:'PEAK B',    bars:8,  energy:1.0, activeTracks:['bd','sd','hh','oh','lt','cb'], color:'#00ffcc' },
            { name:'OUTRO',     bars:4,  energy:0.2, activeTracks:['bd','hh'],                 color:'#0a2a2a' },
        ],
        hiphop: [
            { name:'INTRO',     bars:2,  energy:0.4, activeTracks:['bd','hh'],                 color:'#3a1a00' },
            { name:'VERSE 1',   bars:8,  energy:0.7, activeTracks:['bd','sd','hh','rs'],        color:'#ff9500' },
            { name:'HOOK',      bars:4,  energy:0.9, activeTracks:['bd','sd','hh','oh','cp'],   color:'#ffb500' },
            { name:'VERSE 2',   bars:8,  energy:0.7, activeTracks:['bd','sd','hh','rs','lt'],   color:'#ff8000' },
            { name:'HOOK',      bars:4,  energy:0.9, activeTracks:['bd','sd','hh','oh','cp','cb'], color:'#ffb500' },
            { name:'BRIDGE',    bars:4,  energy:0.5, activeTracks:['bd','hh','lt'],             color:'#3a2a00' },
            { name:'HOOK OUT',  bars:4,  energy:1.0, activeTracks:['bd','sd','hh','oh','cp'],   color:'#ffcc00' },
            { name:'OUTRO',     bars:2,  energy:0.3, activeTracks:['bd','hh'],                 color:'#2a1a00' },
        ],
    };

    // ─── MATH & UTILS ─────────────────────────────────────────────────────────
    function mkRNG(seed) {
        let s = (seed >>> 0) || 1;
        return () => {
            s += 0x6d2b79f5;
            let t = Math.imul(s ^ s>>>15, 1|s);
            t ^= t + Math.imul(t ^ t>>>7, 61|t);
            return ((t ^ t>>>14) >>> 0) / 4294967296;
        };
    }
    const rInt = (min, max, R) => Math.floor(R() * (max - min + 1)) + min;
    const rPick = (arr, R) => arr[Math.floor(R() * arr.length)];

    // ─── DSP HELPERS ──────────────────────────────────────────────────────────
    const wNoise = n => { let a = new Float32Array(n); for(let i=0;i<n;i++) a[i]=Math.random()*2-1; return a; };
    const envExp = (n, tau) => { let a = new Float32Array(n); for(let i=0;i<n;i++) a[i]=Math.exp(-i/tau); return a; };
    const lerp = (v0,v1,t) => v0*(1-t)+v1*t;
    const pitchSweep = (n,f0,f1) => {
        let a=new Float32Array(n), ph=0;
        for(let i=0;i<n;i++) { let f=lerp(f0,f1,i/n); ph+=2*Math.PI*f/SR; a[i]=Math.sin(ph); }
        return a;
    };
    const biquadLP = (src,f,q) => {
        let out=new Float32Array(src.length), w0=2*Math.PI*f/SR, alpha=Math.sin(w0)/(2*q);
        let b1=1-Math.cos(w0), b0=b1/2, b2=b0, a0=1+alpha, a1=-2*Math.cos(w0), a2=1-alpha;
        let x1=0,x2=0,y1=0,y2=0;
        for(let i=0;i<src.length;i++){
            let y=(b0*src[i]+b1*x1+b2*x2-a1*y1-a2*y2)/a0;
            out[i]=y; x2=x1; x1=src[i]; y2=y1; y1=y;
        }
        return out;
    };
    const biquadBP = (src,f,q) => {
        let out=new Float32Array(src.length), w0=2*Math.PI*f/SR, alpha=Math.sin(w0)/(2*q);
        let b0=alpha, b1=0, b2=-alpha, a0=1+alpha, a1=-2*Math.cos(w0), a2=1-alpha;
        let x1=0,x2=0,y1=0,y2=0;
        for(let i=0;i<src.length;i++){
            let y=(b0*src[i]+b1*x1+b2*x2-a1*y1-a2*y2)/a0;
            out[i]=y; x2=x1; x1=src[i]; y2=y1; y1=y;
        }
        return out;
    };
    const sat = (src,amt) => { for(let i=0;i<src.length;i++) src[i]=Math.tanh(src[i]*amt); return src; };
    const norm = src => {
        let max=0; for(let i=0;i<src.length;i++) max=Math.max(max,Math.abs(src[i]));
        if(max>0) for(let i=0;i<src.length;i++) src[i]/=max; return src;
    };
    const mixN = (...args) => {
        let len=args[0].length, out=new Float32Array(len);
        for(let i=0;i<args.length;i+=2) { let buf=args[i],vol=args[i+1]; for(let j=0;j<len;j++) out[j]+=buf[j]*vol; }
        return out;
    };

    // ─── DRUM SYNTHS ──────────────────────────────────────────────────────────
    function dspKick(tune=1, decay=0.5, punch=0.6, dist=0.2) {
        const n = Math.floor(SR * 0.8);
        const sub = pitchSweep(n, 120*tune, 28*tune);
        const sEnv = envExp(n, decay*600);
        for(let i=0;i<n;i++) sub[i] *= sEnv[i];
        const sub2 = new Float32Array(n);
        for(let i=0;i<n;i++) sub2[i] = Math.sin(2*Math.PI*50*tune*i/SR)*Math.exp(-i/(SR*0.2));
        const subF = sat(biquadLP(sub, 100+tune*20, 0.9), 1.0+dist*1.5);
        const click = biquadBP(wNoise(n), 2000+punch*1200, 1.2);
        const cEnv = envExp(n, 4);
        for(let i=0;i<n;i++) click[i] *= cEnv[i] * (0.1+punch*0.2);
        return norm(mixN(subF,1.0, sub2,0.6, click,0.8));
    }
    function dspSnare() {
        const n = Math.floor(SR * 0.5);
        const body = pitchSweep(n, 220, 180);
        const bEnv = envExp(n, 40);
        for(let i=0;i<n;i++) body[i] *= bEnv[i];
        const noise = biquadBP(wNoise(n), 1200, 0.5);
        const nEnv = envExp(n, 120);
        for(let i=0;i<n;i++) noise[i] *= nEnv[i] * 0.8;
        return norm(mixN(body, 0.5, noise, 0.5));
    }
    function dspRimshot() {
        const n = Math.floor(SR * 0.08);
        const t1 = pitchSweep(n, 400, 300);
        const e1 = envExp(n, 10);
        for(let i=0;i<n;i++) t1[i] *= e1[i];
        const noise = biquadBP(wNoise(n), 1600, 2);
        const ne = envExp(n, 8);
        for(let i=0;i<n;i++) noise[i] *= ne[i];
        return norm(mixN(t1, 0.6, noise, 0.4));
    }
    function dspClap() {
        const n = Math.floor(SR * 0.3);
        let out = new Float32Array(n);
        [0, 0.005, 0.010].forEach(offset => {
            const noise = biquadBP(wNoise(Math.floor(SR*0.06)), 1400, 0.8);
            const env = envExp(noise.length, 80);
            for(let i=0;i<noise.length;i++) noise[i] *= env[i];
            const start = Math.floor(offset * SR);
            for(let i=0;i<noise.length && start+i < n;i++) out[start+i] += noise[i] * 0.6;
        });
        return norm(out);
    }
    function dspHat(open=false) {
        const n = Math.floor(SR * (open ? 0.4 : 0.05));
        let noise = wNoise(n);
        noise = biquadBP(noise, open ? 7000 : 9000, 1.2);
        const env = envExp(n, open ? 900 : 80);
        for(let i=0;i<n;i++) noise[i] *= env[i];
        return norm(noise);
    }
    function dspTom(pitch=200) {
        const n = Math.floor(SR * 0.4);
        const body = pitchSweep(n, pitch, pitch*0.5);
        const env = envExp(n, 150);
        for(let i=0;i<n;i++) body[i] *= env[i];
        const noise = biquadBP(wNoise(n), pitch*3, 1.0);
        const ne = envExp(n, 30);
        for(let i=0;i<n;i++) noise[i] *= ne[i] * 0.15;
        return norm(mixN(body, 0.9, noise, 0.1));
    }
    function dspCowbell() {
        const n = Math.floor(SR * 0.3);
        const f1 = 562, f2 = 845;
        const t1 = new Float32Array(n), t2 = new Float32Array(n);
        for(let i=0;i<n;i++) { t1[i] = Math.sin(2*Math.PI*f1*i/SR); t2[i] = Math.sin(2*Math.PI*f2*i/SR); }
        const env = envExp(n, 1000);
        for(let i=0;i<n;i++) { t1[i] *= env[i]; t2[i] *= env[i]; }
        return norm(mixN(t1, 0.5, t2, 0.5));
    }

    // ─── AUDIO INIT ───────────────────────────────────────────────────────────
    function initAudio() {
        if (ctx) return;
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        mComp = ctx.createDynamicsCompressor();
        mComp.threshold.value = -14; mComp.ratio.value = 5;
        bassEQ = ctx.createBiquadFilter(); bassEQ.type = 'lowshelf'; bassEQ.frequency.value = 120; bassEQ.gain.value = 4.5;
        hiCut = ctx.createBiquadFilter(); hiCut.type = 'highshelf'; hiCut.frequency.value = 8000; hiCut.gain.value = -3.5;
        limiter = ctx.createDynamicsCompressor(); limiter.threshold.value = -1; limiter.ratio.value = 20;
        mGain = ctx.createGain(); mGain.gain.value = 0.78;
        analyser = ctx.createAnalyser(); analyser.fftSize = 512;
        mComp.connect(bassEQ); bassEQ.connect(hiCut); hiCut.connect(limiter);
        limiter.connect(mGain); mGain.connect(ctx.destination); mGain.connect(analyser);
        // Reverb
        revSend = ctx.createGain(); revSend.gain.value = 0.12;
        reverbConv = ctx.createConvolver();
        let ir = ctx.createBuffer(2, SR*2, SR);
        for(let c=0;c<2;c++) { let d=ir.getChannelData(c); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/5000); }
        reverbConv.buffer = ir;
        revSend.connect(reverbConv); reverbConv.connect(mGain);
    }

    function toBuffer(floatArr) {
        let b = ctx.createBuffer(1, floatArr.length, SR);
        b.getChannelData(0).set(floatArr);
        return b;
    }

    // ─── PATTERN GENERATION ───────────────────────────────────────────────────
    function getStyleCategory(styleName) {
        const n = styleName.toUpperCase();
        if (n.includes('TECHNO') || n.includes('INDUSTRIAL') || n.includes('MINIMAL')) return 'techno';
        if (n.includes('ACID')) return 'acid';
        return 'hiphop';
    }

    // Pick pattern for a track based on section energy & RNG
    function pickPattern(trackId, sectionEnergy, R, patLib) {
        const pats = patLib[trackId];
        if (!pats || pats.length === 0) return new Array(32).fill(0);
        // Higher energy → prefer busier patterns (later in array)
        const maxIdx = pats.length - 1;
        const bias = Math.floor(sectionEnergy * maxIdx);
        const idx = Math.max(0, Math.min(maxIdx, bias + rInt(-1, 1, R)));
        return [...pats[idx]];
    }

    // Build a variation of a pattern (introduces fills, mutes, etc.)
    function varPattern(pat, variation, R) {
        const p = [...pat];
        if (variation === 'fill') {
            // Last 4 steps: random fills
            for(let i=28;i<32;i++) p[i] = R() > 0.4 ? 2 : 1;
        } else if (variation === 'sparse') {
            for(let i=0;i<32;i++) if(p[i] && R() > 0.6) p[i] = 0;
        } else if (variation === 'dense') {
            for(let i=0;i<32;i++) if(!p[i] && R() > 0.7) p[i] = 1;
        }
        return p;
    }

    // ─── SONG BUILDER ─────────────────────────────────────────────────────────
    function buildSong(R, style) {
        const cat = getStyleCategory(style.name);
        let structTemplate;
        if (cat === 'techno') structTemplate = SONG_STRUCTURES.techno;
        else if (cat === 'acid') structTemplate = SONG_STRUCTURES.acid;
        else structTemplate = SONG_STRUCTURES.hiphop;

        const patLib = PAT_LIB[cat === 'acid' ? 'techno' : cat];
        const allTracks = ['bd','sd','cp','hh','oh','rs','lt','cb'];

        // Build section list with patterns
        const sections = structTemplate.map((tmpl, si) => {
            const sectionBars = [];
            for(let b=0; b<tmpl.bars; b++) {
                const isLastBar = b === tmpl.bars - 1;
                const variation = isLastBar && tmpl.energy > 0.5 ? 'fill' : (tmpl.energy < 0.4 ? 'sparse' : 'normal');
                const bar = {};
                allTracks.forEach(tid => {
                    const active = tmpl.activeTracks.includes(tid);
                    if (!active) { bar[tid] = new Array(32).fill(0); return; }
                    const basePat = pickPattern(tid, tmpl.energy, R, patLib);
                    bar[tid] = variation !== 'normal' ? varPattern(basePat, variation, R) : basePat;
                });
                sectionBars.push(bar);
            }
            return {
                name: tmpl.name,
                bars: tmpl.bars,
                energy: tmpl.energy,
                activeTracks: tmpl.activeTracks,
                color: tmpl.color,
                patternBars: sectionBars,
            };
        });

        // Flatten to absolute bar list
        const barList = [];
        sections.forEach((sec, si) => {
            sec.patternBars.forEach((bar, bi) => {
                barList.push({
                    sectionIdx: si,
                    barInSection: bi,
                    sectionName: sec.name,
                    energy: sec.energy,
                    activeTracks: sec.activeTracks,
                    patterns: bar,
                    color: sec.color,
                });
            });
        });

        return { sections, barList, totalBars: barList.length };
    }

    // ─── CURRENT PATTERNS ─────────────────────────────────────────────────────
    function getCurrentBar() {
        if (!song) return null;
        const idx = globalBar % song.barList.length;
        return song.barList[idx];
    }

    // ─── SCHEDULER ────────────────────────────────────────────────────────────
    function schedulerTick() {
        if (!song || !playing) return;
        const stepDuration = (60 / song.bpm) / 8; // 32nd notes (32 steps per bar = 8 per beat)
        while (nextSchedTime < ctx.currentTime + 0.12) {
            scheduleStep(globalStep, nextSchedTime);
            nextSchedTime += stepDuration;
            globalStep++;
            if (globalStep >= 32) {
                globalStep = 0;
                globalBar++;
                if (globalBar >= song.barList.length) {
                    globalBar = 0; // loop song
                }
                updateBarUI();
            }
        }
    }

    function scheduleStep(step, time) {
        const bar = getCurrentBar();
        if (!bar) return;
        const stepDuration = (60 / song.bpm) / 8;
        let t = time;
        // Swing on odd 16th-note subdivisions (step 2,6,10,14,...)
        if (step % 4 === 2 && song.style.swing > 0) {
            t += (song.style.swing / 200) * stepDuration * 2;
        }

        const vol = song.style.dVol * (0.5 + bar.energy * 0.5);

        allTrackDefs.forEach(td => {
            const pat = bar.patterns[td.id];
            if (!pat) return;
            const val = pat[step];
            if (!val) return;
            const accent = val === 2;
            const gv = vol * (accent ? 1.0 : 0.72);
            if (drumBuffers[td.id]) playDrum(td.id, t, gv);
            if (midiConnected && midiOut) midiDrumNote(td.id, t, accent ? 110 : 85);
        });

        // UI step highlight
        const delay = Math.max(0, (t - ctx.currentTime) * 1000);
        setTimeout(() => {
            if (!playing) return;
            document.querySelectorAll('.s-step.cur').forEach(s => s.classList.remove('cur'));
            const uiStep = step % 16; // show 16 at a time
            document.querySelectorAll(`.s-step[data-step="${uiStep}"]`).forEach(s => s.classList.add('cur'));
            document.getElementById('progress-fill').style.width = `${(step/31)*100}%`;
        }, delay);
    }

    const allTrackDefs = [
        {id:'bd', label:'BD', clr:'var(--ph)'},
        {id:'sd', label:'SD', clr:'var(--red)'},
        {id:'cp', label:'CP', clr:'var(--amb)'},
        {id:'hh', label:'HH', clr:'var(--blu)'},
        {id:'oh', label:'OH', clr:'var(--cyn)'},
        {id:'rs', label:'RS', clr:'var(--grn)'},
        {id:'lt', label:'LT', clr:'var(--pur)'},
        {id:'cb', label:'CB', clr:'#ff66cc'},
    ];

    function playDrum(key, when, vol) {
        const s = ctx.createBufferSource();
        s.buffer = drumBuffers[key];
        const g = ctx.createGain(); g.gain.value = vol;
        s.connect(g); g.connect(mComp);
        s.start(when);
    }

    function playSynth(note, when, dur) {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        const freq = 440 * Math.pow(2, (note - 69) / 12);
        osc.frequency.value = freq; osc.type = 'sawtooth';
        g.gain.setValueAtTime(0, when);
        g.gain.linearRampToValueAtTime(0.3, when + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, when + dur);
        const filter = ctx.createBiquadFilter(); filter.frequency.value = 400;
        osc.connect(filter); filter.connect(g); g.connect(mComp);
        osc.start(when); osc.stop(when + dur);
    }

    // ─── MIDI TR-8 ────────────────────────────────────────────────────────────
    async function connectMidi() {
        const btn = document.getElementById('midi-btn');
        try {
            midiAccess = await navigator.requestMIDIAccess({ sysex: false });
            const outputs = Array.from(midiAccess.outputs.values());
            if (outputs.length > 0) {
                // Prefer TR-8, TR-8S, or first available
                midiOut = outputs.find(o => /tr.?8/i.test(o.name)) ||
                          outputs.find(o => /roland/i.test(o.name)) ||
                          outputs[0];
                midiConnected = true;
                btn.classList.add('connected');
                document.getElementById('midi-device-name').textContent = midiOut.name.toUpperCase().slice(0,20);
                logMidi(`CONNECTED: ${midiOut.name}`);
                // Send MIDI start
                sendMidiTransportMsg(0xFA); // MIDI Start
            } else {
                btn.classList.add('error');
                logMidi('NO MIDI OUTPUT FOUND');
            }
            midiAccess.onstatechange = e => {
                logMidi(`DEVICE ${e.port.state.toUpperCase()}: ${e.port.name}`);
            };
        } catch(e) {
            btn.classList.add('error');
            logMidi('MIDI ACCESS DENIED');
        }
    }

    function sendMidiTransportMsg(msg) {
        if (!midiOut) return;
        try { midiOut.send([msg]); } catch(e) {}
    }

    function midiDrumNote(drumKey, when, velocity) {
        if (!midiConnected || !midiOut) return;
        const note = TR8_NOTES[drumKey];
        if (note === undefined) return;
        const ch = midiChannel;
        const noteOn  = 0x90 | ch;
        const noteOff = 0x80 | ch;
        const delayMs = Math.max(0, (when - ctx.currentTime) * 1000);
        setTimeout(() => {
            try {
                midiOut.send([noteOn, note, velocity]);
                logMidi(`♩ ${drumKey.toUpperCase()} n${note} v${velocity}`, true);
                setTimeout(() => { try { midiOut.send([noteOff, note, 0]); } catch(e) {} }, 30);
            } catch(e) {}
        }, delayMs);
    }

    let midiLogLines = [];
    function logMidi(msg, isNote = false) {
        const mon = document.getElementById('midi-monitor');
        if (!mon) return;
        midiLogLines.push({ msg, isNote });
        if (midiLogLines.length > 40) midiLogLines.shift();
        // Only render non-note spam in monitor; notes shown as dots
        const lines = midiLogLines.filter(l => !l.isNote || !isNote).slice(-10);
        mon.innerHTML = midiLogLines.slice(-12).map(l =>
            `<div class="${l.isNote ? 'midi-log-line' : ''}">${l.msg}</div>`
        ).join('');
        mon.scrollTop = mon.scrollHeight;
    }

    // ─── UI ───────────────────────────────────────────────────────────────────
    function buildSequencerUI() {
        const container = document.getElementById('seq-panel');
        container.innerHTML = '';
        const bar = getCurrentBar();
        if (!bar) return;

        allTrackDefs.forEach(td => {
            const row = document.createElement('div');
            row.className = 'seq-row';
            row.innerHTML = `<div class="seq-label" title="${td.id.toUpperCase()}">${td.label}</div>
                             <div class="seq-grid" id="grid-${td.id}"></div>
                             <div class="vu-wrap" id="vu-${td.id}"><div class="vu-bar" style="--clr:${td.clr}"></div></div>`;
            container.appendChild(row);
            const grid = row.querySelector('.seq-grid');
            // Show first 16 of the 32-step pattern
            for(let i=0; i<16; i++) {
                const step = document.createElement('div');
                step.className = 's-step';
                step.dataset.step = i;
                step.dataset.track = td.id;
                step.style.setProperty('--clr', td.clr);
                const val = bar.patterns[td.id] ? bar.patterns[td.id][i] : 0;
                if (val) { step.classList.add('on'); if(val===2) step.classList.add('acc'); }
                grid.appendChild(step);
            }
        });
    }

    function updateBarUI() {
        const bar = getCurrentBar();
        if (!bar) return;
        // Refresh sequencer grid
        allTrackDefs.forEach(td => {
            const grid = document.getElementById(`grid-${td.id}`);
            if (!grid) return;
            const steps = grid.querySelectorAll('.s-step');
            steps.forEach((el, i) => {
                el.classList.remove('on','acc');
                const val = bar.patterns[td.id] ? bar.patterns[td.id][i] : 0;
                if (val) { el.classList.add('on'); if(val===2) el.classList.add('acc'); }
            });
        });

        const totalBars = song.barList.length;
        const absIdx = globalBar % totalBars;
        document.getElementById('chip-section').textContent = bar.sectionName;
        document.getElementById('chip-bar').textContent = `BAR ${absIdx+1}/${totalBars}`;
        document.getElementById('ui-section').textContent = bar.sectionName;
        document.getElementById('ui-bar-in').textContent = `${bar.barInSection+1}/${song.sections[bar.sectionIdx].bars}`;
        document.getElementById('ui-total-bars').textContent = `${absIdx+1} / ${totalBars}`;
        document.getElementById('ui-energy').textContent = Math.round(bar.energy * 100) + '%';
        document.getElementById('ui-active-instr').textContent = bar.activeTracks.join(' · ').toUpperCase();

        // Timeline highlight
        document.querySelectorAll('.tl-block').forEach((el, i) => {
            el.classList.remove('active','played');
            if (i < absIdx) el.classList.add('played');
            if (i === absIdx) el.classList.add('active');
        });

        // Scroll timeline to keep active block visible
        const activeBlock = document.querySelector('.tl-block.active');
        if (activeBlock) activeBlock.scrollIntoView({ behavior: 'smooth', inline: 'nearest', block: 'nearest' });
    }

    function buildTimeline() {
        const tl = document.getElementById('struct-timeline');
        tl.innerHTML = '';
        song.barList.forEach((bar, i) => {
            const block = document.createElement('div');
            block.className = 'tl-block';
            block.style.background = bar.color;
            block.style.minWidth = Math.max(24, Math.floor(800 / song.barList.length)) + 'px';
            block.title = `${bar.sectionName} – BAR ${bar.barInSection+1}`;
            block.textContent = i % 4 === 0 ? bar.sectionName.slice(0,3) : '';
            block.addEventListener('click', () => {
                globalBar = i; globalStep = 0;
                nextSchedTime = ctx.currentTime + 0.01;
                updateBarUI();
            });
            tl.appendChild(block);
        });
    }

    // ─── VISUALIZER ───────────────────────────────────────────────────────────
    function draw() {
        vizRAF = requestAnimationFrame(draw);
        const canvas = document.getElementById('vid-canvas');
        if (!canvas) return;
        const vc = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;

        const vibe = song ? song.style.vibe : '#05050a';
        vc.fillStyle = 'rgba(5,5,10,0.85)';
        vc.fillRect(0,0,w,h);

        // Grid
        vc.strokeStyle = vibe; vc.globalAlpha = 0.08; vc.lineWidth = 1;
        vc.beginPath();
        for(let i=0;i<w;i+=40) { vc.moveTo(i,0); vc.lineTo(i,h); }
        for(let i=0;i<h;i+=40) { vc.moveTo(0,i); vc.lineTo(w,i); }
        vc.stroke();

        if (analyser) {
            const freqData = new Uint8Array(analyser.frequencyBinCount);
            const timeData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(freqData);
            analyser.getByteTimeDomainData(timeData);

            // Spectrum bars
            vc.globalAlpha = 0.35;
            const barW = w / freqData.length;
            for(let i=0;i<freqData.length;i++) {
                const bh = (freqData[i] / 255) * h;
                vc.fillStyle = vibe;
                vc.fillRect(i*barW, h-bh, barW-1, bh);
            }

            // Waveform
            vc.globalAlpha = 0.9; vc.strokeStyle = vibe; vc.lineWidth = 2;
            vc.beginPath();
            for(let i=0;i<timeData.length;i++) {
                const x = (i/timeData.length)*w;
                const y = (timeData[i]/255)*h;
                if(i===0) vc.moveTo(x,y); else vc.lineTo(x,y);
            }
            vc.stroke();

            // VU bars
            let rms = 0;
            for(let i=0;i<timeData.length;i++) { let v=(timeData[i]-128)/128; rms+=v*v; }
            rms = Math.sqrt(rms/timeData.length);
            document.querySelectorAll('.vu-bar').forEach(el => {
                el.style.height = Math.min(100, rms * 300) + '%';
            });
        }
        vc.globalAlpha = 1;

        if (playing) {
            const now = Date.now();
            if(!lastTs) lastTs = now;
            songTime += now - lastTs;
            lastTs = now;
            const ms  = Math.floor(songTime % 1000 / 10).toString().padStart(2,'0');
            const sec = Math.floor(songTime / 1000 % 60).toString().padStart(2,'0');
            const min = Math.floor(songTime / 60000).toString().padStart(2,'0');
            document.getElementById('vid-time').textContent = `${min}:${sec}:${ms}`;
        }

        // Spectrum canvas (right panel)
        const sc = document.getElementById('spec-canvas');
        if (sc && analyser) {
            const sctx = sc.getContext('2d');
            const sw = sc.width = sc.offsetWidth;
            const sh = sc.height = sc.offsetHeight;
            sctx.fillStyle = '#000';
            sctx.fillRect(0,0,sw,sh);
            const fd = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(fd);
            const vibe2 = song ? song.style.vibe : '#d4ff00';
            for(let i=0;i<fd.length;i++) {
                const bh = (fd[i]/255)*sh;
                sctx.fillStyle = vibe2;
                sctx.globalAlpha = 0.8;
                sctx.fillRect(i*(sw/fd.length), sh-bh, (sw/fd.length)-1, bh);
            }
        }
    }

    // ─── TRANSPORT ────────────────────────────────────────────────────────────
    function playPause() {
        if (!song) { generate(); return; }
        const btn = document.getElementById('t-play');
        if (playing) {
            playing = false;
            clearInterval(seqTimer);
            btn.textContent = '▶'; btn.classList.remove('playing');
            document.getElementById('chip-live').textContent = 'PAUSED';
            if (midiConnected) sendMidiTransportMsg(0xFC); // MIDI Stop
        } else {
            playing = true;
            lastTs = Date.now();
            nextSchedTime = ctx.currentTime + 0.05;
            seqTimer = setInterval(schedulerTick, 12);
            btn.textContent = '⏸'; btn.classList.add('playing');
            document.getElementById('chip-live').textContent = 'LIVE';
            if (midiConnected) sendMidiTransportMsg(0xFB); // MIDI Continue
        }
    }

    function stop() {
        playing = false;
        clearInterval(seqTimer);
        songTime = 0; lastTs = 0; globalStep = 0; globalBar = 0;
        document.getElementById('chip-live').textContent = 'IDLE';
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('t-play').textContent = '▶';
        document.getElementById('t-play').classList.remove('playing');
        document.querySelectorAll('.s-step.cur').forEach(s => s.classList.remove('cur'));
        if (midiConnected) sendMidiTransportMsg(0xFC); // MIDI Stop
        if (song) updateBarUI();
    }

    // ─── GENERATE ─────────────────────────────────────────────────────────────
    async function generate() {
        if (isGenerating) return;
        isGenerating = true;
        const btn = document.getElementById('gen-btn');
        const txt = document.getElementById('gen-txt');
        const ld  = document.getElementById('loading');
        const ldBar  = document.getElementById('ld-bar');
        const ldStep = document.getElementById('ld-steps');

        try {
            stop();
            initAudio();
            if (ctx.state === 'suspended') await ctx.resume();
            btn.classList.add('busy'); txt.textContent = 'RENDERING…';
            ld.classList.add('show');
            const upd = (p, s) => { ldBar.style.width = p+'%'; ldStep.textContent = s; };

            upd(5, 'Synthesizing Kick...');
            await sleep(10);
            drumBuffers.bd = toBuffer(dspKick(1 + Math.random()*0.2, 0.4+Math.random()*0.3));
            upd(15, 'Synthesizing Snare...');
            await sleep(10);
            drumBuffers.sd = toBuffer(dspSnare());
            drumBuffers.cp = toBuffer(dspClap());
            upd(28, 'Synthesizing Hats...');
            await sleep(10);
            drumBuffers.hh = toBuffer(dspHat(false));
            drumBuffers.oh = toBuffer(dspHat(true));
            upd(38, 'Synthesizing Percussion...');
            await sleep(10);
            drumBuffers.rs = toBuffer(dspRimshot());
            drumBuffers.lt = toBuffer(dspTom(160 + Math.random()*60));
            drumBuffers.cb = toBuffer(dspCowbell());

            upd(48, 'Building Song Structure...');
            await sleep(20);

            const R = mkRNG(Date.now());
            const style = rPick(STYLES, R);
            const bpm = bpmOverride || rInt(style.bpm[0], style.bpm[1], R);

            const songData = buildSong(R, style);
            song = { ...songData, style, bpm };

            upd(72, 'Building Pattern Library...');
            await sleep(10);
            upd(85, 'Initializing UI...');
            await sleep(20);

            // UI
            document.getElementById('ui-title').textContent = `TRACK_${Date.now().toString(16).slice(-6).toUpperCase()}`;
            document.getElementById('ui-sub').textContent = `${style.name} // ${song.totalBars} BARS // ${bpm} BPM`;
            document.getElementById('chip-style').textContent = style.name;
            document.getElementById('bpm-display').textContent = bpm;
            document.getElementById('bpm-slider').value = bpm;
            document.getElementById('vid-bpm').textContent = `${bpm} BPM`;
            document.getElementById('ui-mood').textContent = getStyleCategory(style.name).toUpperCase();

            buildTimeline();
            buildSequencerUI();
            updateBarUI();

            upd(100, 'Ready. Press PLAY.');
            await sleep(600);
            ld.classList.remove('show');
            playPause();

        } catch(err) {
            console.error(err);
            ld.classList.remove('show');
        } finally {
            btn.classList.remove('busy');
            txt.textContent = 'GENERATE';
            isGenerating = false;
        }
    }

    const sleep = ms => new Promise(r => setTimeout(r, ms));

    // ─── INIT ─────────────────────────────────────────────────────────────────
    function addBtn(id, fn) {
        const el = document.getElementById(id);
        if (!el) return;
        let touched = false;
        el.addEventListener('touchstart', e => { e.preventDefault(); touched = true; fn(); }, { passive:false });
        el.addEventListener('click', () => { if(touched){touched=false;return;} fn(); });
    }

    function init() {
        addBtn('gen-btn', generate);
        addBtn('t-play', playPause);
        addBtn('t-stop', stop);
        addBtn('midi-btn', connectMidi);

        document.getElementById('bpm-slider').addEventListener('input', e => {
            bpmOverride = parseInt(e.target.value);
            document.getElementById('bpm-display').textContent = bpmOverride;
            if (song) song.bpm = bpmOverride;
        });

        document.getElementById('midi-ch-select').addEventListener('change', e => {
            midiChannel = parseInt(e.target.value);
            logMidi(`CHANNEL SET: ${midiChannel+1}`);
        });

        draw();
        logMidi('// NEXUS GEN v6 ready');
        logMidi('// TR-8 MIDI mode: CH 10');
    }

    window.addEventListener('load', init);
    return { generate, playPause, stop };
})();
</script>
</body>
</html>
